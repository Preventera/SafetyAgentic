"""
Dashboard Safety Coordinator - Mode Operations OPTIMIS√â BBS-ISO 45001
Version R√âVOLUTIONNAIRE - Int√©gration compl√®te m√©triques comportementales et conformit√© normative
"""

import streamlit as st
import plotly.graph_objects as go
from datetime import datetime, timedelta
import pandas as pd

def display_safety_coordinator_dashboard(config):
    """Dashboard Safety Coordinator - Mode Operations avec BBS-ISO 45001 int√©gr√©"""
    
    # Header professionnel avec contexte op√©rationnel
    st.markdown("## ‚ö° Safety Coordinator Operations Dashboard")
    st.markdown("*Mode Op√©rationnel - Coordination terrain et incidents | BBS-ISO 45001 Int√©gr√©*")
    
    # === M√âTRIQUES TEMPS R√âEL ENRICHIES BBS-ISO ===
    col1, col2, col3, col4, col5 = st.columns(5)
    
    with col1:
        st.metric("üö® Incidents Actifs", "7", delta="-2")
    
    with col2:
        st.metric("üìä Compliance ISO", "94.3%", delta="+1.8%", help="ISO 45001 Ch.5.4 Participation")
    
    with col3:
        st.metric("üë• √âquipes Actives", "12/15", delta="2")
    
    with col4:
        st.metric("‚è±Ô∏è Temps R√©solution", "2.4h", delta="-0.3h")
    
    with col5:
        st.metric("üéØ BBS Score", "85.2%", delta="+2.1%", help="Behavioral Safety Index")
    
    # === SECTION BBS D√âDI√âE (NOUVEAU) ===
    st.markdown("### üß† **Behavioral Safety (BBS) - Performance Temps R√©el**")
    
    bbs_col1, bbs_col2, bbs_col3, bbs_col4 = st.columns(4)
    
    with bbs_col1:
        st.metric(
            "üìä Observations BBS", 
            "47/60", 
            delta="12 aujourd'hui",
            help="Target: 60 observations/jour"
        )
    
    with bbs_col2:
        st.metric(
            "‚úÖ Comportements S√ªrs", 
            "88.7%", 
            delta="+3.2%",
            help="% Comportements conformes observ√©s"
        )
    
    with bbs_col3:
        st.metric(
            "‚ö° Feedback Moyen", 
            "12 min", 
            delta="-3 min",
            help="Target: <15 minutes post-observation"
        )
    
    with bbs_col4:
        st.metric(
            "üéØ Coaching Ratio", 
            "78/22", 
            delta="Target 80/20",
            help="Positif/Correctif (ISO Ch.7 Communication)"
        )
    
    # === ALERTES BBS INTELLIGENTES (NOUVEAU) ===
    st.markdown("### üö® **Alertes BBS Intelligentes**")
    
    alert_col1, alert_col2 = st.columns(2)
    
    with alert_col1:
        st.warning("‚ö†Ô∏è **Observation BBS Due**: √âquipe Beta - Zone B4-B6 (derni√®re: 3h)")
        st.info("üìä **Pattern D√©tect√©**: Augmentation EPI non conformes Zone C (+15%)")
    
    with alert_col2:
        st.success("‚úÖ **Coaching Positif**: √âquipe Alpha excellent comportement s√©curitaire")
        st.error("üö® **Comportement Risqu√©**: Zone D10-D12 - Intervention BBS requise")
    
    # === LAYOUT PRINCIPAL ===
    col_main, col_actions = st.columns([2, 1])
    
    with col_main:
        # === TIMELINE INTERACTIVE ENRICHIE BBS ===
        st.markdown("### üìÖ Timeline Op√©rationnelle + BBS")
        
        # Timeline avec composants BBS int√©gr√©s
        timeline_events = [
            {"time": "08:15", "event": "Inspection Zone A termin√©e + 5 observations BBS", "status": "‚úÖ TERMIN√â", "priority": "success", "bbs": True},
            {"time": "09:30", "event": "Incident mineur Secteur B + Analyse comportementale", "status": "üîÑ EN COURS", "priority": "warning", "bbs": True},
            {"time": "10:45", "event": "Formation √©quipe Nuit + Module BBS", "status": "üìö PLANIFI√â", "priority": "info", "bbs": True},
            {"time": "11:20", "event": "Maintenance pr√©ventive + Observations s√©curit√©", "status": "‚ö° URGENT", "priority": "error", "bbs": True},
            {"time": "12:00", "event": "R√©union coordination + Feedback BBS √©quipes", "status": "üìÖ PROGRAMM√â", "priority": "info", "bbs": True},
            {"time": "13:30", "event": "Coaching BBS √âquipe Delta", "status": "üéØ BBS", "priority": "bbs_focus", "bbs": True},
            {"time": "14:15", "event": "Observation positive √âquipe Gamma", "status": "‚úÖ BBS+", "priority": "bbs_positive", "bbs": True}
        ]
        
        for event in timeline_events:
            # Ic√¥ne BBS si applicable
            bbs_icon = "üß† " if event.get("bbs") else ""
            
            if event["priority"] == "error":
                st.error(f"**{event['time']}** - {bbs_icon}{event['event']} - {event['status']}")
            elif event["priority"] == "warning":
                st.warning(f"**{event['time']}** - {bbs_icon}{event['event']} - {event['status']}")
            elif event["priority"] == "success":
                st.success(f"**{event['time']}** - {bbs_icon}{event['event']} - {event['status']}")
            elif event["priority"] == "bbs_focus":
                st.markdown(f"üéØ **{event['time']}** - {event['event']} - {event['status']}")
            elif event["priority"] == "bbs_positive":
                st.markdown(f"üü¢ **{event['time']}** - {event['event']} - {event['status']}")
            else:
                st.info(f"**{event['time']}** - {bbs_icon}{event['event']} - {event['status']}")
    
    with col_actions:
        # === ACTIONS RAPIDES ENRICHIES BBS-ISO ===
        st.markdown("### üéØ Actions Rapides BBS-ISO")
        
        # 1. OBSERVATION BBS (NOUVEAU)
        if st.button("üß† Observation BBS", use_container_width=True, type="primary", key="bbs_observation"):
            st.success("‚úÖ Module Observation BBS activ√© !")
            
            with st.expander("üìã Saisie Observation Comportementale", expanded=True):
                col_obs1, col_obs2 = st.columns(2)
                with col_obs1:
                    team_observed = st.selectbox("√âquipe", ["Alpha", "Beta", "Gamma", "Delta", "Echo"], key="obs_team")
                    behavior_type = st.selectbox("Comportement", ["‚úÖ S√ªr", "‚ö†Ô∏è √Ä risque", "üö® Dangereux"], key="obs_behavior")
                with col_obs2:
                    location = st.text_input("Zone", placeholder="Ex: A1-A3", key="obs_location")
                    observer = st.text_input("Observateur", value="Safety Coordinator", key="obs_observer")
                
                behavior_detail = st.text_area("D√©tail comportement observ√©", 
                                               placeholder="Description pr√©cise du comportement...", 
                                               key="obs_detail")
                
                # Feedback imm√©diat
                feedback_given = st.checkbox("Feedback donn√© imm√©diatement", key="obs_feedback")
                
                if st.button("üì§ Enregistrer Observation BBS", use_container_width=True, key="save_bbs_obs"):
                    # G√©n√©ration rapport BBS
                    bbs_report = f"""
üß† OBSERVATION BBS - {datetime.now().strftime('%d/%m/%Y %H:%M')}

üë• √âquipe observ√©e: {team_observed}
üìç Zone: {location}
üéØ Type comportement: {behavior_type}
üë§ Observateur: {observer}

üìù Description comportement:
{behavior_detail}

üí¨ Feedback imm√©diat: {'‚úÖ Oui' if feedback_given else '‚ùå Non'}

üìä SCORING BBS:
‚Ä¢ Observation #47 du jour (Target: 60)
‚Ä¢ Contribution score √©quipe: +2.3%
‚Ä¢ Impact culture s√©curit√©: Positif

üèÜ CONFORMIT√â ISO 45001:
‚Ä¢ Ch.5.4 Participation travailleurs: ‚úÖ
‚Ä¢ Ch.7 Communication efficace: ‚úÖ
‚Ä¢ Ch.10 Am√©lioration continue: ‚úÖ

‚è∞ Temps observation: {datetime.now().strftime('%d/%m/%Y √† %H:%M')}
üîó ID Observation: BBS-{datetime.now().strftime('%Y%m%d-%H%M%S')}
üë§ Safety Coordinator: {observer}
üè¢ Site: SafetyGraph Industries - Enterprise ABC
                    """
                    
                    st.success("‚úÖ Observation BBS enregistr√©e et int√©gr√©e au scoring global !")
                    st.download_button(
                        label="üì• Export Observation BBS",
                        data=bbs_report,
                        file_name=f"observation_bbs_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt",
                        mime="text/plain",
                        key="download_bbs_obs"
                    )
        
        # 2. D√âCLARER INCIDENT enrichi BBS
        if st.button("üö® D√©clarer Incident + BBS", use_container_width=True, key="incident_bbs"):
            st.balloons()
            st.success("‚úÖ Formulaire incident + Analyse comportementale !")
            
            with st.expander("üìã Incident + Analyse BBS", expanded=True):
                col_form1, col_form2 = st.columns(2)
                with col_form1:
                    incident_type = st.selectbox("Type", ["Chute", "√âquipement", "Chimique", "Autre"], key="inc_type_bbs")
                    severity = st.selectbox("Gravit√©", ["üî¥ Critique", "üü° Mod√©r√©", "üü¢ Mineur"], key="inc_severity_bbs")
                with col_form2:
                    location = st.text_input("Zone", placeholder="Ex: Secteur A-12", key="inc_location_bbs")
                    team_involved = st.selectbox("√âquipe impliqu√©e", ["Alpha", "Beta", "Gamma", "Delta", "Echo"], key="inc_team")
                
                description = st.text_area("Description incident", placeholder="D√©tails de l'incident...", key="inc_desc_bbs")
                
                # Section BBS
                st.markdown("**üß† Analyse Comportementale (BBS)**")
                behavioral_factor = st.selectbox("Facteur comportemental", 
                                                ["Aucun", "Proc√©dure non suivie", "Formation insuffisante", 
                                                 "Pression temps", "√âquipement inad√©quat", "Communication d√©faillante"],
                                                key="bbs_factor")
                
                if behavioral_factor != "Aucun":
                    bbs_recommendation = st.text_area("Recommandations BBS", 
                                                      placeholder="Actions comportementales recommand√©es...",
                                                      key="bbs_recommendations")
                
                if st.button("üì§ Envoyer Rapport Incident+BBS", use_container_width=True, key="send_incident_bbs"):
                    # G√©n√©ration du rapport enrichi
                    incident_bbs_report = f"""
üö® RAPPORT INCIDENT + ANALYSE BBS - {datetime.now().strftime('%d/%m/%Y %H:%M')}

üìç Zone: {location}
üïê Heure: {datetime.now().strftime('%H:%M')}
‚ö†Ô∏è Type: {incident_type}
üéØ Gravit√©: {severity}
üë• √âquipe impliqu√©e: {team_involved}

üìù Description incident:
{description}

üß† ANALYSE COMPORTEMENTALE (BBS):
‚Ä¢ Facteur comportemental identifi√©: {behavioral_factor}
{'‚Ä¢ Recommandations BBS: ' + bbs_recommendation if behavioral_factor != "Aucun" else '‚Ä¢ Aucun facteur comportemental identifi√©'}

üìä IMPACT SUR M√âTRIQUES BBS:
‚Ä¢ R√©vision observations √©quipe {team_involved}
‚Ä¢ Formation cibl√©e requise: {'‚úÖ Oui' if behavioral_factor != "Aucun" else '‚ùå Non'}
‚Ä¢ Coaching additionnel: {'‚úÖ Recommand√©' if behavioral_factor != "Aucun" else '‚ùå Non requis'}

üèÜ CONFORMIT√â ISO 45001:
‚Ä¢ Ch.6 Gestion risques: Investigation comportementale ‚úÖ
‚Ä¢ Ch.10 Am√©lioration continue: Plan d'action BBS ‚úÖ
‚Ä¢ Ch.5.4 Participation: Implication √©quipe ‚úÖ

üë§ Rapport√© par: Safety Coordinator
üîó ID: INC-BBS-{datetime.now().strftime('%Y%m%d-%H%M%S')}
üìç Localisation GPS: 45.5017¬∞ N, 73.5673¬∞ W
üè¢ Site: SafetyGraph Industries - Enterprise ABC
                    """
                    
                    st.success("‚úÖ Rapport incident + analyse BBS g√©n√©r√© et envoy√© !")
                    st.download_button(
                        label="üì• T√©l√©charger Rapport Incident+BBS",
                        data=incident_bbs_report,
                        file_name=f"incident_bbs_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt",
                        mime="text/plain",
                        key="download_incident_bbs"
                    )
        
        # 3. COACHING BBS (NOUVEAU)
        if st.button("üéØ Session Coaching BBS", use_container_width=True, key="coaching_bbs"):
            st.success("‚úÖ Module Coaching BBS activ√© !")
            
            with st.expander("üéØ Coaching Comportemental", expanded=True):
                coach_col1, coach_col2 = st.columns(2)
                with coach_col1:
                    target_team = st.selectbox("√âquipe cible", ["Alpha", "Beta", "Gamma", "Delta", "Echo"], key="coach_team")
                    coaching_type = st.selectbox("Type coaching", ["‚úÖ Renforcement positif", "‚ö†Ô∏è Correction comportement", "üìö Formation cibl√©e"], key="coach_type")
                with coach_col2:
                    coach_location = st.text_input("Zone intervention", placeholder="Ex: B4-B6", key="coach_location")
                    duration = st.selectbox("Dur√©e estim√©e", ["15 min", "30 min", "45 min", "1h"], key="coach_duration")
                
                coaching_objective = st.text_area("Objectifs coaching", 
                                                  placeholder="Comportements sp√©cifiques √† adresser...",
                                                  key="coach_objectives")
                
                if st.button("üöÄ Programmer Coaching", use_container_width=True, key="schedule_coaching"):
                    coaching_plan = f"""
üéØ PLAN COACHING BBS - {datetime.now().strftime('%d/%m/%Y %H:%M')}

üë• √âquipe cible: {target_team}
üìç Zone intervention: {coach_location}
üéØ Type coaching: {coaching_type}
‚è±Ô∏è Dur√©e: {duration}

üìù Objectifs coaching:
{coaching_objective}

üìÖ PLANIFICATION:
‚Ä¢ Heure pr√©vue: {(datetime.now() + timedelta(hours=1)).strftime('%H:%M')}
‚Ä¢ M√©thode: Coaching terrain direct
‚Ä¢ Approche: {'Positive - Renforcement' if 'positif' in coaching_type else 'Corrective - Am√©lioration'}

üìä SUIVI BBS:
‚Ä¢ Impact attendu score √©quipe: +5-10%
‚Ä¢ Indicateurs surveillance: Observations post-coaching
‚Ä¢ Feedback requis: 24-48h post-intervention

üèÜ ALIGNEMENT ISO 45001:
‚Ä¢ Ch.5.4 Consultation: Approche participative ‚úÖ
‚Ä¢ Ch.7 Communication: Dialogue ouvert ‚úÖ
‚Ä¢ Ch.10 Am√©lioration: Actions concr√®tes ‚úÖ

üë§ Coach: Safety Coordinator
‚è∞ Programm√©: {datetime.now().strftime('%d/%m/%Y √† %H:%M')}
üè¢ Site: SafetyGraph Industries - Enterprise ABC
                    """
                    
                    st.success("‚úÖ Session coaching BBS programm√©e avec succ√®s !")
                    st.download_button(
                        label="üì• Export Plan Coaching",
                        data=coaching_plan,
                        file_name=f"coaching_bbs_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt",
                        mime="text/plain",
                        key="download_coaching"
                    )
        
        # 4. RAPPORT FLASH BBS-ISO (ENRICHI)
        if st.button("üìä Rapport Flash BBS-ISO", use_container_width=True, key="report_bbs_iso"):
            st.success("‚úÖ G√©n√©ration rapport int√©gr√© BBS-ISO 45001 !")
            
            with st.expander("üìà Rapport Flash - Synth√®se BBS-ISO 45001", expanded=True):
                flash_report_bbs = f"""
‚ö° RAPPORT FLASH BBS-ISO 45001 INT√âGR√â
üìÖ {datetime.now().strftime('%d/%m/%Y √† %H:%M')}
üè¢ SafetyGraph Industries - Enterprise ABC

üìä M√âTRIQUES TEMPS R√âEL CONSOLID√âES:
‚Ä¢ Incidents actifs: 7 (-2 vs hier) ‚úÖ
‚Ä¢ Compliance ISO 45001: 94.3% (+1.8% ce mois) üèÜ
‚Ä¢ BBS Score global: 85.2% (+2.1% am√©lioration) üß†
‚Ä¢ √âquipes actives: 12/15 (80% op√©rationnel)
‚Ä¢ Temps r√©solution: 2.4h (-0.3h am√©lioration) ‚úÖ

üß† PERFORMANCE BBS D√âTAILL√âE:
‚Ä¢ Observations r√©alis√©es: 47/60 (78% objectif quotidien)
‚Ä¢ Comportements s√ªrs: 88.7% (+3.2% vs semaine derni√®re) ‚úÖ
‚Ä¢ Feedback moyen: 12 min (-3 min am√©lioration) ‚úÖ
‚Ä¢ Coaching ratio: 78/22 (Target 80/20 - Ajustement requis)
‚Ä¢ Sessions coaching: 3 programm√©es aujourd'hui

üèÜ CONFORMIT√â ISO 45001 PAR CHAPITRE:
‚Ä¢ Ch.5 Leadership: 96.7% - Engagement direction visible ‚úÖ
‚Ä¢ Ch.5.4 Participation: 94.3% - BBS favorise implication ‚úÖ
‚Ä¢ Ch.7 Communication: 93.1% - Feedback BBS efficace ‚úÖ
‚Ä¢ Ch.8 Op√©rations: 91.8% - Proc√©dures int√©gr√©es BBS ‚úÖ
‚Ä¢ Ch.9 Performance: 95.2% - Monitoring BBS continu ‚úÖ
‚Ä¢ Ch.10 Am√©lioration: 92.7% - Actions correctives BBS ‚úÖ

üö® SITUATIONS CRITIQUES BBS-ISO:
‚Ä¢ Zone D10-D12: Comportement risqu√© d√©tect√© - Coaching urgent ‚úÖ
‚Ä¢ √âquipe Beta: Retard observations (3h sans BBS) - Action requise
‚Ä¢ Formation BBS: 2 √©quipes n√©cessitent mise √† niveau
‚Ä¢ Ratio coaching: Ajustement vers 80/20 (actuellement 78/22)

‚úÖ POINTS POSITIFS BBS-ISO:
‚Ä¢ √âquipe Alpha: Excellent comportement - Renforcement positif ‚úÖ
‚Ä¢ Zone A: Inspection + 5 observations BBS r√©ussies ‚úÖ
‚Ä¢ Formation nuit: Module BBS int√©gr√© planifi√© ‚úÖ
‚Ä¢ Trend positif: +3.2% comportements s√ªrs cette semaine ‚úÖ

üéØ ACTIONS RECOMMAND√âES BBS-ISO:
1. Coaching urgent Zone D10-D12 (comportement risqu√©)
2. Rattrapage observations √âquipe Beta (3h sans BBS)
3. Formation BBS pour 2 √©quipes (certification √† jour)
4. Ajustement coaching ratio: +2% positif pour atteindre 80/20
5. Capitaliser excellence √âquipe Alpha (best practices)

üìç ZONES SURVEILLANCE RENFORC√âE:
‚Ä¢ Zone D10-D12: Intervention BBS imm√©diate requise
‚Ä¢ Secteur B: Incident + analyse comportementale en cours
‚Ä¢ √âquipes Beta/Delta: Surveillance observations renforc√©e

üìà TENDANCES BBS-ISO INT√âGR√âES:
‚Ä¢ Score BBS: +15% am√©lioration mensuelle üß†
‚Ä¢ Conformit√© ISO: +8% progression trimestrielle üèÜ
‚Ä¢ Incidents avec facteur comportemental: -22% ‚úÖ
‚Ä¢ Participation √©quipes: +12% engagement volontaire ‚úÖ
‚Ä¢ Coaching efficacit√©: 87% (target 90%) üìä

üí° PROCHAINES √âCH√âANCES BBS-ISO:
‚Ä¢ 12:00 - R√©union coordination + Feedback BBS √©quipes
‚Ä¢ 13:30 - Coaching BBS √âquipe Delta (programm√©)
‚Ä¢ 14:15 - Formation √©quipe Nuit + Module BBS
‚Ä¢ 15:30 - Audit ISO Ch.5.4 Participation (pr√©paration)
‚Ä¢ 16:00 - D√©briefing incidents + Analyse comportementale

üéØ OBJECTIFS SEMAINE BBS-ISO:
‚Ä¢ Atteindre 60 observations/jour (actuellement 47)
‚Ä¢ Maintenir 90%+ comportements s√ªrs
‚Ä¢ Coaching ratio optimal 80/20
‚Ä¢ Conformit√© ISO maintenir >94%
‚Ä¢ Z√©ro incident avec facteur comportemental

üë§ Rapport g√©n√©r√© par: Safety Coordinator
üîó Version: SafetyGraph Industries v3.1 BBS-ISO Enhanced
üìç Site: Enterprise ABC - Construction (SCIAN 236)
‚è∞ Derni√®re MAJ: {datetime.now().strftime('%d/%m/%Y √† %H:%M:%S')}
üèÜ Certification: ISO 45001 en cours (audit Q3 2024)
                """
                
                st.text_area("üìÑ Rapport Flash BBS-ISO Int√©gr√©", flash_report_bbs, height=500, key="flash_bbs_content")
                
                col_export1, col_export2 = st.columns(2)
                with col_export1:
                    st.download_button(
                        label="üì• Export Rapport BBS-ISO",
                        data=flash_report_bbs,
                        file_name=f"rapport_bbs_iso_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt",
                        mime="text/plain",
                        use_container_width=True,
                        key="download_flash_bbs"
                    )
                with col_export2:
                    if st.button("üìß Envoyer Management+ISO", use_container_width=True, key="send_management_bbs"):
                        st.success("‚úÖ Rapport BBS-ISO envoy√© au management + auditeur ISO !")
                        st.info("üì¨ Email envoy√© √†: direction@safetygraph.com, iso.auditor@safetygraph.com")
        
        # === ALERTES CONTEXTUELLES ENRICHIES ===
        st.markdown("### ‚ö†Ô∏è Alertes BBS-ISO")
        st.warning("üß† Observation BBS due: √âquipe Beta (3h)")
        st.info("üéØ Coaching BBS planifi√© 13h30")
        st.error("üö® Comportement risqu√© Zone D - BBS urgent")
        st.success("‚úÖ ISO Ch.5.4: Participation excellente")
    
    # === ONGLETS D√âTAILL√âS ENRICHIS BBS-ISO ===
    tab1, tab2, tab3, tab4 = st.tabs(["üìä Incidents+BBS", "üë• √âquipes+Coaching", "üìà Performance BBS", "üèÜ Conformit√© ISO"])
    
    with tab1:
        st.markdown("#### Incidents + Analyse Comportementale")
        
        # Graphique √©volution incidents avec facteurs BBS
        fig_incidents = go.Figure()
        fig_incidents.add_trace(go.Scatter(
            x=['Lun', 'Mar', 'Mer', 'Jeu', 'Ven'],
            y=[12, 8, 15, 7, 9],
            mode='lines+markers',
            name='Incidents Total',
            line=dict(color='orange', width=3),
            marker=dict(size=8)
        ))
        fig_incidents.add_trace(go.Scatter(
            x=['Lun', 'Mar', 'Mer', 'Jeu', 'Ven'],
            y=[4, 2, 6, 2, 1],
            mode='lines+markers',
            name='Avec Facteur Comportemental',
            line=dict(color='red', width=2),
            marker=dict(size=6)
        ))
        fig_incidents.update_layout(
            title="√âvolution Incidents + Analyse BBS",
            height=300
        )
        st.plotly_chart(fig_incidents, use_container_width=True, key="incidents_bbs_chart")
        
        # Tableau incidents avec analyse BBS
        incidents_bbs_data = {
            'ID': ['INC-BBS-001', 'INC-BBS-002', 'INC-BBS-003'],
            'Zone': ['D10-D12', 'Secteur B', 'Zone C'],
            'Type': ['Chute', '√âquipement', 'Chimique'],
            'Facteur BBS': ['Proc√©dure ignor√©e', 'Formation insuffisante', 'Aucun'],
            'Coaching': ['‚úÖ Programm√©', 'üîÑ En cours', '‚ùå Non requis'],
            'Statut': ['Investigation BBS', 'R√©solu+Formation', 'Clos']
        }
        st.dataframe(incidents_bbs_data, use_container_width=True)
    
    with tab2:
        st.markdown("#### Gestion √âquipes + Coaching BBS")
        
        # M√©triques √©quipes avec BBS
        eq_col1, eq_col2, eq_col3, eq_col4 = st.columns(4)
        with eq_col1:
            st.metric("√âquipes Actives", "12/15")
        with eq_col2:
            st.metric("Score BBS Moyen", "85.2%")
        with eq_col3:
            st.metric("Coaching Sessions", "3/jour")
        with eq_col4:
            st.metric("Participation BBS", "94.3%")
        
        # Tableau √©quipes avec scoring BBS
        teams_bbs_data = {
            '√âquipe': ['Alpha', 'Beta', 'Gamma', 'Delta', 'Echo'],
            'Zone': ['A1-A3', 'B4-B6', 'C7-C9', 'D10-D12', 'E13-E15'],
            'Score BBS': ['92.1%', '78.3%', '89.7%', '71.2%', '86.8%'],
            'Observations': ['12/12', '8/12', '11/12', '6/12', '10/12'],
            'Coaching': ['‚úÖ Positif', '‚ö†Ô∏è Requis', '‚úÖ Excellent', 'üö® Urgent', '‚úÖ Bon'],
            'ISO Ch.5.4': ['96%', '89%', '94%', '85%', '92%']
        }
        st.dataframe(teams_bbs_data, use_container_width=True)
    
    with tab3:
        st.markdown("#### Performance BBS D√©taill√©e")
        
        # Graphique comportements s√ªrs/√† risque
        fig_behavior = go.Figure(data=[go.Pie(
            labels=['Comportements S√ªrs', '√Ä Risque', 'Dangereux'],
            values=[88.7, 9.8, 1.5],
            hole=.3,
            marker_colors=['green', 'orange', 'red']
        )])
        fig_behavior.update_layout(
            title="R√©partition Comportements Observ√©s (BBS)",
            height=300
        )
        st.plotly_chart(fig_behavior, use_container_width=True, key="behavior_distribution")
        
        # M√©triques de coaching
        coaching_col1, coaching_col2, coaching_col3 = st.columns(3)
        with coaching_col1:
            st.metric("Coaching Positif", "78%", delta="Target: 80%")
        with coaching_col2:
            st.metric("Coaching Correctif", "22%", delta="Target: 20%")
        with coaching_col3:
            st.metric("Efficacit√© Coaching", "87%", delta="Target: 90%")
        
        # Timeline BBS des derni√®res 24h
        st.markdown("**Timeline BBS - Derni√®res 24h**")
        bbs_timeline_data = {
            'Heure': ['08:15', '09:30', '10:45', '12:00', '13:30', '14:15', '15:00'],
            'Action BBS': [
                'Observation positive √âquipe Alpha',
                'Comportement risqu√© d√©tect√© Zone D',
                'Coaching correctif √âquipe Beta',
                'Formation BBS √©quipe Nuit',
                'Observation excellente √âquipe Gamma',
                'Feedback positif donn√©',
                'R√©vision proc√©dure Zone C'
            ],
            'Impact': ['+2.3%', '-1.1%', '+1.8%', '+0.5%', '+2.7%', '+1.2%', '+0.8%'],
            'Statut': ['‚úÖ Compl√©t√©', 'üîÑ En cours', '‚úÖ Compl√©t√©', 'üìö Planifi√©', '‚úÖ Compl√©t√©', '‚úÖ Compl√©t√©', 'üìã En r√©vision']
        }
        st.dataframe(bbs_timeline_data, use_container_width=True)
    
    with tab4:
        st.markdown("#### Conformit√© ISO 45001 - Int√©gration BBS")
        
        # Scoring par chapitre ISO 45001
        iso_chapters = [
            {'Chapitre': 'Ch.5 Leadership', 'Score': 96.7, 'BBS Integration': '‚úÖ Leadership visibility tours', 'Statut': 'üèÜ Excellent'},
            {'Chapitre': 'Ch.5.4 Participation', 'Score': 94.3, 'BBS Integration': '‚úÖ Observations volontaires', 'Statut': 'üèÜ Excellent'},
            {'Chapitre': 'Ch.7 Communication', 'Score': 93.1, 'BBS Integration': '‚úÖ Feedback imm√©diat', 'Statut': '‚úÖ Conforme'},
            {'Chapitre': 'Ch.8 Op√©rations', 'Score': 91.8, 'BBS Integration': '‚úÖ Proc√©dures BBS int√©gr√©es', 'Statut': '‚úÖ Conforme'},
            {'Chapitre': 'Ch.9 Performance', 'Score': 95.2, 'BBS Integration': '‚úÖ Monitoring comportemental', 'Statut': 'üèÜ Excellent'},
            {'Chapitre': 'Ch.10 Am√©lioration', 'Score': 92.7, 'BBS Integration': '‚úÖ Actions correctives BBS', 'Statut': '‚úÖ Conforme'}
        ]
        
        iso_df = pd.DataFrame(iso_chapters)
        st.dataframe(iso_df, use_container_width=True)
        
        # Graphique radar conformit√© ISO
        fig_iso = go.Figure()
        
        fig_iso.add_trace(go.Scatterpolar(
            r=[96.7, 94.3, 93.1, 91.8, 95.2, 92.7],
            theta=['Leadership', 'Participation', 'Communication', 'Op√©rations', 'Performance', 'Am√©lioration'],
            fill='toself',
            name='Score Actuel',
            line_color='blue'
        ))
        
        fig_iso.add_trace(go.Scatterpolar(
            r=[95, 95, 95, 95, 95, 95],
            theta=['Leadership', 'Participation', 'Communication', 'Op√©rations', 'Performance', 'Am√©lioration'],
            fill='toself',
            name='Target ISO',
            line_color='green',
            line=dict(dash='dash')
        ))
        
        fig_iso.update_layout(
            polar=dict(
                radialaxis=dict(
                    visible=True,
                    range=[80, 100]
                )),
            title="Conformit√© ISO 45001 - Int√©gration BBS",
            height=400
        )
        st.plotly_chart(fig_iso, use_container_width=True, key="iso_compliance_radar")
        
        # Actions d'am√©lioration ISO-BBS
        st.markdown("**üéØ Plan d'Action ISO-BBS**")
        st.info("üìã **Ch.8 Op√©rations** : Int√©grer davantage proc√©dures BBS (91.8% ‚Üí 95%)")
        st.info("üìã **Ch.10 Am√©lioration** : Syst√©matiser retour d'exp√©rience BBS (92.7% ‚Üí 95%)")
        st.success("üèÜ **Ch.5 Leadership** : Excellence maintenue - Leadership visibility (96.7%)")
        st.success("üèÜ **Ch.9 Performance** : Monitoring BBS optimal (95.2%)")
        
        # Prochaines √©ch√©ances audit ISO
        st.markdown("**üìÖ √âch√©ances Audit ISO 45001**")
        audit_schedule = {
            'Date': ['15 Ao√ªt 2024', '22 Ao√ªt 2024', '29 Ao√ªt 2024', '05 Sept 2024'],
            'Audit': ['Ch.5 Leadership', 'Ch.5.4 & 7 Participation/Communication', 'Ch.8 & 9 Op√©rations/Performance', 'Ch.10 Am√©lioration Continue'],
            'Pr√©paration BBS': ['Tours direction + BBS', 'Observations + Feedback', 'Proc√©dures + Monitoring', 'Actions correctives'],
            'Statut': ['‚úÖ Pr√™t', 'üîÑ En pr√©paration', 'üìã √Ä pr√©parer', 'üìã √Ä pr√©parer']
        }
        st.dataframe(audit_schedule, use_container_width=True)
    
    # === FOOTER AVEC R√âSUM√â GLOBAL ===
    st.markdown("---")
    st.markdown("### üìà **R√©sum√© Performance Globale BBS-ISO 45001**")
    
    summary_col1, summary_col2, summary_col3 = st.columns(3)
    
    with summary_col1:
        st.markdown("""
        **üß† Performance BBS**
        - Score global: **85.2%** ‚ÜóÔ∏è
        - Observations: **47/60** (78%)
        - Comportements s√ªrs: **88.7%** ‚úÖ
        - Coaching ratio: **78/22** (‚Üí80/20)
        """)
    
    with summary_col2:
        st.markdown("""
        **üèÜ Conformit√© ISO 45001**
        - Score global: **94.3%** ‚úÖ
        - Leadership (Ch.5): **96.7%** üèÜ
        - Participation (Ch.5.4): **94.3%** ‚úÖ
        - Performance (Ch.9): **95.2%** üèÜ
        """)
    
    with summary_col3:
        st.markdown("""
        **üéØ Actions Prioritaires**
        - Coaching urgent Zone D10-D12 üö®
        - Rattrapage observations √âquipe Beta ‚ö†Ô∏è
        - Optimiser ratio coaching 80/20 üìä
        - Pr√©paration audit ISO Ch.8-10 üìã
        """)
    
    # === BOUTON EXPORT GLOBAL ===
    st.markdown("---")
    if st.button("üìä **EXPORT DASHBOARD COMPLET BBS-ISO**", use_container_width=True, type="primary", key="export_complete_dashboard"):
        
        complete_export = f"""
‚ö° DASHBOARD SAFETY COORDINATOR COMPLET - BBS-ISO 45001 INT√âGR√â
üìÖ Export g√©n√©r√©: {datetime.now().strftime('%d/%m/%Y √† %H:%M:%S')}
üè¢ SafetyGraph Industries - Enterprise ABC - Safety Coordinator Operations

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìä M√âTRIQUES PRINCIPALES CONSOLID√âES:
‚Ä¢ Incidents actifs: 7 (-2 vs hier)
‚Ä¢ Compliance ISO 45001: 94.3% (+1.8% mensuel)
‚Ä¢ BBS Score global: 85.2% (+2.1% am√©lioration)
‚Ä¢ √âquipes actives: 12/15 (80% op√©rationnel)
‚Ä¢ Temps r√©solution: 2.4h (-0.3h am√©lioration)

üß† PERFORMANCE BBS D√âTAILL√âE:
‚Ä¢ Observations r√©alis√©es: 47/60 (78% objectif quotidien)
‚Ä¢ Comportements s√ªrs: 88.7% (+3.2% vs semaine derni√®re)
‚Ä¢ Feedback moyen: 12 min (-3 min am√©lioration)
‚Ä¢ Coaching ratio: 78/22 (Target 80/20)
‚Ä¢ Sessions coaching programm√©es: 3 aujourd'hui

üèÜ CONFORMIT√â ISO 45001 D√âTAILL√âE:
‚Ä¢ Ch.5 Leadership: 96.7% - Leadership visibility excellent
‚Ä¢ Ch.5.4 Participation: 94.3% - BBS favorise implication
‚Ä¢ Ch.7 Communication: 93.1% - Feedback BBS efficace
‚Ä¢ Ch.8 Op√©rations: 91.8% - Proc√©dures BBS int√©gr√©es
‚Ä¢ Ch.9 Performance: 95.2% - Monitoring continu
‚Ä¢ Ch.10 Am√©lioration: 92.7% - Actions correctives syst√©matiques

üéØ PERFORMANCE PAR √âQUIPE:
‚Ä¢ √âquipe Alpha (A1-A3): 92.1% BBS - ‚úÖ Excellence
‚Ä¢ √âquipe Beta (B4-B6): 78.3% BBS - ‚ö†Ô∏è Am√©lioration requise
‚Ä¢ √âquipe Gamma (C7-C9): 89.7% BBS - ‚úÖ Tr√®s bon
‚Ä¢ √âquipe Delta (D10-D12): 71.2% BBS - üö® Intervention urgente
‚Ä¢ √âquipe Echo (E13-E15): 86.8% BBS - ‚úÖ Bon niveau

üö® ALERTES ET ACTIONS CRITIQUES:
‚Ä¢ Zone D10-D12: Comportement risqu√© - Coaching BBS urgent
‚Ä¢ √âquipe Beta: 3h sans observation - Rattrapage imm√©diat
‚Ä¢ Ratio coaching: Ajustement +2% positif requis (78‚Üí80%)
‚Ä¢ Formation BBS: 2 √©quipes n√©cessitent mise √† niveau

üìÖ PLANNING ACTIONS BBS-ISO:
‚Ä¢ 12:00 - R√©union coordination + Feedback BBS √©quipes
‚Ä¢ 13:30 - Coaching BBS urgent √âquipe Delta
‚Ä¢ 14:15 - Formation √©quipe Nuit + Module BBS
‚Ä¢ 15:30 - Audit ISO Ch.5.4 pr√©paration
‚Ä¢ 16:00 - D√©briefing incidents + Analyse comportementale

üìà TENDANCES √âVOLUTION (30 jours):
‚Ä¢ Score BBS: +15% am√©lioration progressive
‚Ä¢ Conformit√© ISO: +8% progression trimestrielle
‚Ä¢ Incidents comportementaux: -22% r√©duction
‚Ä¢ Participation volontaire: +12% engagement
‚Ä¢ Efficacit√© coaching: 87% (target 90%)

üéØ OBJECTIFS SEMAINE BBS-ISO:
‚Ä¢ Atteindre 60 observations/jour (actuellement 47)
‚Ä¢ Maintenir 90%+ comportements s√ªrs
‚Ä¢ Optimiser coaching ratio 80/20
‚Ä¢ Conformit√© ISO >94% tous chapitres
‚Ä¢ Z√©ro incident avec facteur comportemental

üèÜ CERTIFICATION ISO 45001:
‚Ä¢ Statut: En cours de certification
‚Ä¢ Audit pr√©vu: Q3 2024 (Ao√ªt-Septembre)
‚Ä¢ Pr√©paration: 94.3% conforme
‚Ä¢ Points forts: Leadership + Performance + BBS
‚Ä¢ Points am√©lioration: Op√©rations + Am√©lioration continue

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üë§ Dashboard g√©n√©r√© par: Safety Coordinator
üîó Version: SafetyGraph Industries v3.1 BBS-ISO Enhanced
üìç Site: Enterprise ABC - Construction (SCIAN 236)
‚è∞ Export: {datetime.now().strftime('%d/%m/%Y √† %H:%M:%S')}
üåê Plateforme: SafetyGraph Industries + Culture SST + BehaviorX
        """
        
        st.success("‚úÖ Export dashboard complet BBS-ISO 45001 g√©n√©r√© avec succ√®s !")
        
        st.download_button(
            label="üì• **T√âL√âCHARGER DASHBOARD COMPLET BBS-ISO**",
            data=complete_export,
            file_name=f"dashboard_safety_coordinator_bbs_iso_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt",
            mime="text/plain",
            use_container_width=True,
            key="download_complete_dashboard"
        )
        
        st.balloons()
        st.success("üéâ **Dashboard Safety Coordinator BBS-ISO 45001 - Version R√©volutionnaire Pr√™te !**")